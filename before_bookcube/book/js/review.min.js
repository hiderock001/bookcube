require(["jquery","bookcube","rating"],function(e,a){function t(){e(".js_review_write_form textarea[name=review_content]").val(y),a.isLogin()&&e(".js_review_write_form textarea[name=review_content]").focus(function(){e(this).val()==y&&e(this).val("")}).blur(function(){0==e.trim(e(this).val()).length&&e(this).val(y)})}function n(){e.post("/mobile/data/_review_list.asp",{book_type:p,book_num:m,series_num:v,sort:f,pageNum:h},function(e){_=e.list_count,d=e.pagecount,b=e.list,i(),_>0?r():w.hide()},"json")}function s(a){e.post("/mobile/data/_review_process.asp",a,function(e){e.success?(h="add"==a.mode?1:h,n(),c()):(alert(e.message),n())},"json")}function i(){if(e(".review_count").text(_),b.length>0){for(var a,t,n="",s=0;s<b.length;s++)a=o(b[s].content),t=b[s].modify_yn?'<a href="#" class="more npd0 js_review_modify_btn">수정</a><a href="#" class="more npd0 js_review_del_btn">삭제</a>':b[s].recommend_yn?"&nbsp;":'<a href="#" class="btn type5 js_review_recommend_btn">좋아요</a>',n+='<li class="tborder3" data-pos="'+s+'"><div class="comment_list"><span class="star_rank rank'+b[s].point+'"></span> | 좋아요 : <span class="fc_orange2 js_review_recommend_count">'+b[s].recommend_count+"</span>회<dl><dt>"+b[s].nickname+" | "+b[s].input_time+'</dt><dd class="fc_gray content">'+a.content+'</dd></dl><div class="div_type3 mg-t10"><div class="tab_item align_l">&nbsp;</div><div class="tab_item">'+a.more_btn+'</div><div class="tab_item align_r">'+t+"</div></div></div></li>";e("#reviewList").empty().append("<ul>"+n+"</ul>"),e("#reviewList li:odd").addClass("odd"),e("#reviewList li:even").addClass("even")}else e("#reviewList").empty()}function r(){for(var e,a=parseInt((h-1)/g)*g+1,t=d>a+(g-1)?a+(g-1):d,n="",s="",i="",r=a;r<=t;r++)page_class=r==h?"active":"",btn_class=r==h?"":"btn type7",i+='<li class="'+page_class+'" style="display:inline"><span><a href="#" class="'+btn_class+' js_page" data-page-num="'+r+'">'+r+"</a></span></li>\n";a>1&&(n='<a href="#" class="btn type6 prev js_page" data-page-num="'+(a-1)+'" alt="prev"><span class="icon left1"></span></a>'),t<d&&(s='<a href="#" class="btn type6 next js_page" data-page-num="'+(t+1)+'" alt="next"><span class="icon right1"></span></a>'),e='<div class="pagingArea"><div class="paging">'+n+'<span class="page-num"><ul class="pager">'+i+"</ul></span>"+s+'</div><p class="pagecount" style="text-align:center"><span class="indicator">'+h+" / "+d+"</span></p></div>",w.empty().append(e),w.show()}function o(e){var a,t=0,n="",s="&nbsp;";if(e.length>0){a=e.split("<br>");for(var i,r=0;r<a.length;r++){if(n+=0!=r?"<br>":"",i=t+a[r].length,i>120){n+=a[r].substr(0,120-t)+"...",s='<a href="#" class="more js_review_content_more">더보기<span class="icon down1"></span></a>';break}t+=i,n+=a[r]}}return{content:n,more_btn:s}}function c(){u.find(".js_review_modify_form").remove(),u.find("#reviewList li").show(),e(".review_form_area").find("textarea[name=review_content]").val(y)}function l(){e("html, body").animate({scrollTop:e(".detail_tab").offset().top},1e3)}var d,_,p,m,v,f,u,w,h=1,b=[],g=5,y=a.isLogin()?"이전에 작성한 서평 삭제 시 지급된 적립금도 차감됩니다.":"로그인 후 이용가능힙니다.",k='<div class="review_form_area" data-mode="modify"><div class="star_gogo"><span class="star_p">별점 주기 :</span><input class="star required" type="radio" name="m_star" value="1"/><input class="star" type="radio" name="m_star" value="2" /><input class="star" type="radio" name="m_star" value="3" /><input class="star" type="radio" name="m_star" value="4" /><input class="star" type="radio" name="m_star" value="5" /></div><div class="review_textarea"><textarea name="review_content"></textarea></div><div class="mg-t5 align_r"><a href="#" class="more npd0 js_review_write">확인</a>&nbsp;<a href="#" class="more npd0 js_review_write_cancel">취소</a></div>';e(function(){p=e("#wrap").data("book-type"),m=e("#wrap").data("book-num"),v=e("#wrap").data("series-num"),u=e(".review"),f=e(".review_sort input[name=sort]:checked").val(),w=e(".review .paging_area"),t(),n(),u.on("click",".js_review_modify_btn",function(a){a.preventDefault(),c();var t=e('<li class="tborder3 js_review_modify_form">'+k+"</li>"),n=e(this).closest("li"),s=n.data("pos"),i=b[s].content.replace(/<br>/g,"\n"),r=b[s].point;n.hide().after(t.hide().fadeIn("slow")),e("#reviewList").find(".review_form_area").data("pos",s),e("#reviewList").find(".review_form_area textarea[name=review_content]").val(i),e("#reviewList").find("input[name=m_star]").each(function(){e(this).val()==r&&e(this).prop("checked",!0)}),e("#reviewList").find(".review_form_area input[type=radio].star").rating()}),u.on("click",".js_review_write",function(t){if(t.preventDefault(),!a.isLogin())return confirm("로그인 후 이용가능힙니다.\n로그인 하시겠습니까?")&&(location.href="https://"+a.host()+"/mobile/_common/member/login.asp?return_url="+encodeURIComponent(document.URL)),!1;var n,i=e(this).closest(".review_form_area"),r=i.data("mode"),o=i.data("pos"),c="undefined"!=typeof o?b[o].num:"",l=i.find("textarea[name=review_content]").val(),d=i.find("input[type=radio].star:checked").val();return 0==e.trim(l).length||l==y?(alert("서평을 작성해 주세요."),!1):(n={mode:r,book_type:p,book_num:m,series_num:v,num:c,content:l,point:d},void s(n))}),u.on("click",".js_review_write_cancel",function(e){e.preventDefault(),c()}),u.on("click",".js_review_del_btn",function(a){a.preventDefault();var t,n=e(this).closest("li"),i=n.data("pos"),r=b[i].num;t={mode:"del",book_type:p,num:r},s(t)}),u.on("click",".js_review_content_more",function(a){a.preventDefault();var t=e(this).closest("li"),n=b[t.data("pos")].content;if(e(this).find("span").hasClass("down1"))t.find(".content").html(n),e(this).html('닫기<span class="icon up1"></span>');else{var s=o(n);t.find(".content").html(s.content),e(this).html('더보기<span class="icon down1"></span>')}}),u.on("click",".review_sort label",function(){e(".review_sort label").removeClass("fc_orange2").addClass("fc_white"),e(".review_sort label").find("span").removeClass("radio_on").addClass("radio_off"),e(".review_sort input[name=sort]").prop("checked",!1),e(this).closest(".tab_item").find("input[name=sort]").prop("checked",!0),e(this).removeClass("fc_white").addClass("fc_orange2"),e(this).find("span").removeClass("radio_off").addClass("radio_on"),f=e(".review_sort input[name=sort]:checked").val(),h=1,n(),l()}),w.on("click",".js_page",function(a){a.preventDefault(),h=e(this).data("page-num"),n(),l()}),u.on("click",".js_review_recommend_btn",function(a){a.preventDefault();var t=e(this).closest("li"),n=t.data("pos"),s=b[n].num,i=b[n].recommend_count,r=e(this);e.post("/mobile/data/_review_recommend_proc.asp",{book_type:p,num:s},function(e){e.success?(t.find(".js_review_recommend_count").text(parseInt(i)+1),r.closest(".tab_item").html("&nbsp;")):alert(e.message)},"json")})})});